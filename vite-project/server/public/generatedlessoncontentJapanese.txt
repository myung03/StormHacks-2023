## COMM 205: 経営情報システム入門
## 第23講: データセットのマージ、パートII

<?!>## データセットのマージ
このコースでは、データセットをマージする2つの方法をカバーします。
1. **inner_join()**
2. **left_join()**
データセットを結合することで、特定の属性の値が一致する2つのデータセットから観測値をマッチさせることができます。
データセットをマージする際、デフォルトの構文を使用するには、両方のデータセットの属性の変数名が同じである必要があります。
また、両方のデータセットのキー変数の変数タイプも同じであることが推奨されます。

<?!>## left_join()関数
**left_join(x, y)** は、xのすべての行と、xとyのすべての列を返します。
前回と同じexample1とexample2のデータセットを使ってみましょう。今回は、example1のデータセットをexample2からできるだけ多くの情報を持ってくることで改善したいとします。
つまり、example1データセットのすべての観測値を保持し、example2データセットのマッチング観測値に新しい情報をもたらしたいと考えています。
このタスクには、**left_join()** が適しています。

<?!>## left_join()関数
これを行うには、コンソールに以下を入力します。
```
merged2 <- left_join(example1,example2)
```
Rは、Joining, by = c("gvkey", "fyear")を返します。

<?!>## left_join()関数
この場合、gvkeyとfyearの組み合わせに一致する属性の値について、**left_join()** は両方のデータセットに表示される情報をリンクします。
「左」データセットの観測値がもう一方のデータセットにマッチング観測値がない場合、結果として得られるマージされたデータセットに保持されます。一方、「右」データセットの観測値がもう一方のデータセットにマッチング観測値がない場合、結果として得られるデータセットには保持されません。
これが、2014年と2015年のAARコーポレーションの資産と売上が欠けている理由です。example2データセットは、その年にはカバーされていません（2016年度から2018年度までが対象）。

<?!>## 一対一でないマッチング
2つのデータセットをマージする際、キー変数がデータセット内の各観測値を一意に識別する場合、このようなマージは一対一のマージと呼ばれます。
ただし、2つのデータセットの観測値をマッチさせるための基準となる属性（つまり、列）は、両方のデータセットのキー変数である必要はありません。
このような状況では、一方のデータセットの観測値が、もう一方のデータセットの複数の観測値と一対一でないマッチングを通じてマッチすることができます。
ただし、マージを実行する変数または変数は、少なくともデータセットのいずれかを一意に識別する必要があります。

<?!>## 一対一でないマッチング
2つのデータセットがあり、最初のデータセットは、完全な北米株式市場1994-2018.rdsデータセットのサブセットです。
example3.rdsは、fyear==2016のすべての観測値のgvkey、fyear、業界コード（naicsh）を含んでいます。
また、example3を簡単に作成することもできます。
```
example3 <- companies %>%
filter(fyear==2016, !is.na(naicsh)) %>%
select(gvkey, fyear, conm, naicsh)
```

<?!>## 一対一でないマッチング
これは、example3の画像です。

<?!>## 一対一でないマッチング
NAICS_2_6_digit_codes.rdsは、2,200以上の業界（2桁から6桁レベル）のNAICSコードと業界の説明を含んでいます。これはCanvasで提供されています。

<?!>## 一対一でないマッチング
あなたは、次の変数を持つ観測値になるように、2つのデータセットをマージしたいと考えています。gvkey、fyear、naicsh、およびNAICS_description。これにより、Example3データセットのすべての観測値に業界の説明が追加されることになります。
これを行うには、コンソールに以下を入力します。
```
merged3 <- left_join(example3, NAICS_2_6_digit_codes, by = c("naicsh" = "NAICS"))
```

<?!>## 一対一でないマッチング
結果として、次のように表示されるはずです。
